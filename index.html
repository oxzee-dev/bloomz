<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MINI BLOOMBERG TERMINAL</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script>
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        terminal: {
                            bg: '#0a0a0a',
                            panel: '#111111',
                            border: '#1a1a1a',
                            orange: '#ff6600',
                            orangeDim: 'rgba(255, 102, 0, 0.1)',
                            green: '#00ff41',
                            red: '#ff3333',
                            yellow: '#ffcc00',
                            cyan: '#00ffff',
                            gray: '#666666',
                            light: '#cccccc',
                        }
                    },
                    fontFamily: {
                        mono: ['"Courier New"', 'Courier', 'monospace'],
                    }
                }
            }
        }
    </script>
    <style>
        * {
            box-sizing: border-box;
            font-family: "Courier New", Courier, monospace;
        }
        
        body {
            background-color: #000000;
            color: #cccccc;
            overflow: hidden;
            height: 100vh;
            display: flex;
            flex-direction: column;
            font-size: 12px;
            line-height: 1.4;
        }
        
        .scanline {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(to bottom, rgba(255,255,255,0), rgba(255,255,255,0) 50%, rgba(0,0,0,0.1) 50%, rgba(0,0,0,0.1));
            background-size: 100% 4px;
            pointer-events: none;
            z-index: 9999;
            opacity: 0.03;
        }
        
        .ticker-tape {
            background: #0a0a0a;
            border-bottom: 1px solid #1a1a1a;
            overflow: hidden;
            white-space: nowrap;
            position: relative;
            height: 28px;
            line-height: 28px;
        }
        
        .ticker-content {
            display: inline-flex;
            animation: ticker 50s linear infinite;
        }
        
        .ticker-item {
            display: inline-flex;
            align-items: center;
            padding: 0 16px;
            border-right: 1px solid #1a1a1a;
            font-size: 11px;
        }
        
        .ticker-item:hover {
            background: #1a1a1a;
            cursor: pointer;
        }
        
        @keyframes ticker {
            0% { transform: translateX(0); }
            100% { transform: translateX(-50%); }
        }
        
        .chat-container {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
            scroll-behavior: smooth;
            background: #000000;
        }
        
        .chat-message {
            margin-bottom: 16px;
            animation: fadeIn 0.2s ease-in;
            border-left: 2px solid #ff6600;
            padding-left: 12px;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(5px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .command-line {
            color: #444444;
            margin-bottom: 6px;
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 10px;
            text-transform: uppercase;
        }
        
        .timestamp {
            color: #333333;
            font-size: 9px;
        }
        
        .input-area {
            border-top: 1px solid #1a1a1a;
            background: #0a0a0a;
            padding: 10px 16px;
            position: relative;
        }
        
        .command-input {
            background: #000000;
            border: 1px solid #333333;
            outline: none;
            color: #ff6600;
            font-family: "Courier New", monospace;
            text-transform: uppercase;
            width: 100%;
            font-size: 12px;
            padding: 8px 12px;
            letter-spacing: 0.5px;
        }
        
        .command-input:focus {
            border-color: #ff6600;
            box-shadow: 0 0 5px rgba(255, 102, 0, 0.3);
        }
        
        .autocomplete-dropdown {
            position: absolute;
            bottom: 100%;
            left: 16px;
            right: 16px;
            background: #111111;
            border: 1px solid #333333;
            max-height: 150px;
            overflow-y: auto;
            z-index: 100;
            display: none;
            font-size: 11px;
        }
        
        .autocomplete-item {
            padding: 6px 12px;
            cursor: pointer;
            color: #888888;
            border-bottom: 1px solid #1a1a1a;
        }
        
        .autocomplete-item:hover, .autocomplete-item.selected {
            background: rgba(255, 102, 0, 0.1);
            color: #ff6600;
        }
        
        .quick-buttons {
            display: flex;
            gap: 6px;
            margin-top: 8px;
            overflow-x: auto;
            padding-bottom: 4px;
        }
        
        .quick-btn {
            padding: 4px 10px;
            background: #111111;
            border: 1px solid #333333;
            color: #666666;
            font-size: 10px;
            cursor: pointer;
            white-space: nowrap;
            transition: all 0.15s;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .quick-btn:hover {
            background: rgba(255, 102, 0, 0.1);
            border-color: #ff6600;
            color: #ff6600;
        }
        
        .panel {
            background: #111111;
            border: 1px solid #1a1a1a;
        }
        
        .panel:hover {
            border-color: #333333;
        }
        
        .panel-header {
            background: #0a0a0a;
            border-bottom: 1px solid #1a1a1a;
            padding: 8px 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .section-title {
            color: #ff6600;
            font-size: 11px;
            letter-spacing: 1px;
            text-transform: uppercase;
            font-weight: bold;
        }
        
        .metric-card {
            background: #111111;
            border: 1px solid #1a1a1a;
            position: relative;
            overflow: hidden;
            transition: all 0.2s;
        }
        
        .metric-card:hover {
            border-color: #333333;
            transform: translateY(-1px);
        }
        
        .metric-card.positive { border-top: 2px solid #00ff41; }
        .metric-card.negative { border-top: 2px solid #ff3333; }
        .metric-card.neutral { border-top: 2px solid #ff6600; }
        
        .card-dynamic-positive {
            border-left: 2px solid #00ff41;
            background: rgba(0, 255, 65, 0.05);
        }
        
        .card-dynamic-negative {
            border-left: 2px solid #ff3333;
            background: rgba(255, 51, 51, 0.05);
        }
        
        .card-dynamic-neutral {
            border-left: 2px solid #ff6600;
            background: rgba(255, 102, 0, 0.05);
        }
        
        .value-up { color: #00ff41; }
        .value-down { color: #ff3333; }
        .value-neutral { color: #ffcc00; }
        
        .loading {
            display: inline-block;
            width: 12px;
            height: 12px;
            border: 1px solid #1a1a1a;
            border-top: 1px solid #ff6600;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }
        
        ::-webkit-scrollbar-track {
            background: #000000;
        }
        
        ::-webkit-scrollbar-thumb {
            background: #1a1a1a;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: #333333;
        }
        
        .tradingview-widget-container {
            height: 500px;
            width: 100%;
            margin: 16px 0;
            border: 1px solid #1a1a1a;
        }
        
        .data-table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .data-table th {
            background: #0a0a0a;
            color: #ff6600;
            font-weight: bold;
            text-transform: uppercase;
            font-size: 9px;
            letter-spacing: 0.5px;
            padding: 8px;
            text-align: left;
            border-bottom: 1px solid #1a1a1a;
        }
        
        .data-table td {
            padding: 8px;
            font-size: 11px;
            border-bottom: 1px solid #1a1a1a;
        }
        
        .data-table tr:hover td {
            background: rgba(255, 102, 0, 0.03);
        }
        
        .range-bar {
            height: 4px;
            background: #1a1a1a;
            position: relative;
            margin-top: 4px;
        }
        
        .range-fill {
            position: absolute;
            height: 100%;
            background: #ff6600;
        }
        
        .range-marker {
            position: absolute;
            width: 2px;
            height: 100%;
            background: #ffffff;
            top: 0;
        }
        
        .grid-section {
            display: grid;
            gap: 8px;
            margin-bottom: 16px;
        }
        
        .grid-2 { grid-template-columns: repeat(2, 1fr); }
        .grid-3 { grid-template-columns: repeat(3, 1fr); }
        .grid-4 { grid-template-columns: repeat(4, 1fr); }
        .grid-6 { grid-template-columns: repeat(6, 1fr); }
        
        @media (max-width: 768px) {
            .grid-4, .grid-6 { grid-template-columns: repeat(2, 1fr); }
        }
        
        .compact-stat {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 6px 0;
            border-bottom: 1px solid #1a1a1a;
        }
        
        .compact-stat:last-child {
            border-bottom: none;
        }
        
        .recommendation-badge {
            display: inline-block;
            padding: 2px 8px;
            font-size: 10px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border: 1px solid;
        }
        
        .rec-buy { color: #00ff41; border-color: #00ff41; background: rgba(0, 255, 65, 0.1); }
        .rec-sell { color: #ff3333; border-color: #ff3333; background: rgba(255, 51, 51, 0.1); }
        .rec-hold { color: #ffcc00; border-color: #ffcc00; background: rgba(255, 204, 0, 0.1); }
        
        .news-item {
            padding: 8px;
            border-bottom: 1px solid #1a1a1a;
            cursor: pointer;
            transition: all 0.15s;
        }
        
        .news-item:hover {
            background: rgba(255, 102, 0, 0.05);
            border-left: 2px solid #ff6600;
            margin-left: -2px;
        }
        
        .divider {
            height: 1px;
            background: #1a1a1a;
            margin: 16px 0;
        }
    </style>
<base target="_blank">
</head>
<body>
    <div class="scanline"></div>
    
    <!-- Rolling Ticker Tape -->
    <div class="ticker-tape">
        <div class="ticker-content" id="tickerTape"></div>
    </div>
    
    <!-- Header -->
    <header class="border-b border-gray-800 bg-black p-2 flex justify-between items-center shrink-0">
        <div class="flex items-center gap-3">
            <div class="flex items-center gap-2">
                <i class="fas fa-terminal text-orange-600 text-sm"></i>
                <span class="text-gray-400 text-sm tracking-widest font-bold">MINI BLOOMBERG</span>
                <span class="text-gray-600 text-xs px-2 py-0.5 border border-gray-700">PRO</span>
            </div>
            <div class="h-3 w-px bg-gray-800"></div>
            <div class="flex items-center gap-1.5 text-xs">
                <span class="w-1.5 h-1.5 rounded-full bg-green-500 animate-pulse"></span>
                <span class="text-gray-500">LIVE</span>
            </div>
        </div>
        <div class="flex gap-4 text-xs font-mono">
            <div class="flex items-center gap-1.5">
                <i class="fas fa-clock text-gray-600 text-xs"></i>
                <span id="clock" class="text-gray-500">00:00:00</span>
            </div>
        </div>
    </header>
    
    <!-- Chat Output Area -->
    <div id="chatContainer" class="chat-container">
        <div id="welcomeMessage" class="p-4">
            <div class="mb-4">
                <div class="flex items-center justify-between mb-3">
                    <div class="flex items-center gap-2">
                        <div class="w-0.5 h-6 bg-orange-600"></div>
                        <div>
                            <div class="text-lg text-gray-300 font-bold tracking-wider">MARKET DASHBOARD</div>
                            <div class="text-xs text-gray-600 uppercase tracking-widest">Real-Time Intelligence</div>
                        </div>
                    </div>
                    <div class="flex gap-2 text-xs">
                        <div class="text-center px-3 py-1.5 bg-gray-900 border border-gray-800">
                            <div class="text-gray-500 text-xs uppercase">Session</div>
                            <div class="text-gray-300 font-mono font-bold" id="marketSession">REG</div>
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-2 md:grid-cols-4 gap-2 mb-4">
                    <div class="panel p-3 border-t-2 border-orange-600">
                        <div class="flex justify-between items-start mb-1">
                            <span class="text-gray-500 text-xs uppercase">S&P 500</span>
                            <i class="fas fa-chart-line text-gray-600 text-xs"></i>
                        </div>
                        <div class="text-lg text-gray-200 font-mono font-bold" id="dash-sp500">--</div>
                        <div class="text-xs font-mono" id="dash-sp500-change">--</div>
                    </div>
                    
                    <div class="panel p-3 border-t-2 border-orange-600">
                        <div class="flex justify-between items-start mb-1">
                            <span class="text-gray-500 text-xs uppercase">NASDAQ</span>
                            <i class="fas fa-microchip text-gray-600 text-xs"></i>
                        </div>
                        <div class="text-lg text-gray-200 font-mono font-bold" id="dash-nasdaq">--</div>
                        <div class="text-xs font-mono" id="dash-nasdaq-change">--</div>
                    </div>
                    
                    <div class="panel p-3 border-t-2 border-orange-600">
                        <div class="flex justify-between items-start mb-1">
                            <span class="text-gray-500 text-xs uppercase">VIX</span>
                            <i class="fas fa-wave-square text-gray-600 text-xs"></i>
                        </div>
                        <div class="text-lg text-gray-200 font-mono font-bold" id="dash-vix">--</div>
                        <div class="text-xs text-gray-500 font-mono">VOLATILITY</div>
                    </div>
                    
                    <div class="panel p-3 border-t-2 border-orange-600">
                        <div class="flex justify-between items-start mb-1">
                            <span class="text-gray-500 text-xs uppercase">BTC/USD</span>
                            <i class="fab fa-bitcoin text-gray-600 text-xs"></i>
                        </div>
                        <div class="text-lg text-gray-200 font-mono font-bold" id="dash-btc">--</div>
                        <div class="text-xs font-mono" id="dash-btc-change">--</div>
                    </div>
                </div>

                <div class="panel p-3 mb-4">
                    <div class="flex items-center justify-between mb-2">
                        <span class="text-gray-500 text-xs uppercase tracking-wider">Sector Performance</span>
                        <span class="text-xs text-gray-600">Top Movers</span>
                    </div>
                    <div class="grid grid-cols-3 md:grid-cols-6 gap-1.5" id="sector-miniview"></div>
                </div>

                <div class="panel p-3 mb-4" id="welcome-news-section" style="display: none;">
                    <div class="flex items-center justify-between mb-2">
                        <span class="text-gray-500 text-xs uppercase tracking-wider">Market News</span>
                        <span class="text-xs text-gray-600">SPY Feed</span>
                    </div>
                    <div class="space-y-1" id="welcome-news-list"></div>
                </div>
            </div>
            
            <div class="bg-gray-900/50 border border-gray-800 rounded p-4">
                <div class="text-gray-500 font-mono mb-3 text-center text-xs tracking-widest uppercase">
                    Quick Access Commands
                </div>
                <div class="grid grid-cols-2 md:grid-cols-6 gap-2">
                    <div class="text-center p-2 border border-gray-800 hover:border-orange-600/50 hover:bg-orange-600/5 transition-all cursor-pointer" onclick="executeQuickCommand('WEI')">
                        <div class="text-gray-400 text-xs font-mono font-bold">WEI</div>
                        <div class="text-gray-600 text-xs uppercase">World Indices</div>
                    </div>
                    <div class="text-center p-2 border border-gray-800 hover:border-orange-600/50 hover:bg-orange-600/5 transition-all cursor-pointer" onclick="executeQuickCommand('GP')">
                        <div class="text-gray-400 text-xs font-mono font-bold">GP</div>
                        <div class="text-gray-600 text-xs uppercase">Global Perf</div>
                    </div>
                    <div class="text-center p-2 border border-gray-800 hover:border-orange-600/50 hover:bg-orange-600/5 transition-all cursor-pointer" onclick="executeQuickCommand('STX')">
                        <div class="text-gray-400 text-xs font-mono font-bold">STX</div>
                        <div class="text-gray-600 text-xs uppercase">Stock Matrix</div>
                    </div>
                    <div class="text-center p-2 border border-gray-800 hover:border-orange-600/50 hover:bg-orange-600/5 transition-all cursor-pointer" onclick="executeQuickCommand('CRYP')">
                        <div class="text-gray-400 text-xs font-mono font-bold">CRYP</div>
                        <div class="text-gray-600 text-xs uppercase">Crypto</div>
                    </div>
                    <div class="text-center p-2 border border-gray-800 hover:border-orange-600/50 hover:bg-orange-600/5 transition-all cursor-pointer" onclick="executeQuickCommand('BOND')">
                        <div class="text-gray-400 text-xs font-mono font-bold">BOND</div>
                        <div class="text-gray-600 text-xs uppercase">Rates</div>
                    </div>
                    <div class="text-center p-2 border border-gray-800 hover:border-orange-600/50 hover:bg-orange-600/5 transition-all cursor-pointer" onclick="executeQuickCommand('ETF')">
                        <div class="text-gray-400 text-xs font-mono font-bold">ETF</div>
                        <div class="text-gray-600 text-xs uppercase">Thematic</div>
                    </div>
                </div>
            </div>
            
            <div class="text-center mt-4 text-gray-600 text-xs font-mono">
                Type <span class="text-orange-600">GO TICKER</span> for full analysis (e.g., GO AAPL)
            </div>
        </div>
        <div id="chatHistory"></div>
        <div id="loadingIndicator" class="hidden p-3 text-center">
            <span class="loading mr-2"></span>
            <span class="text-gray-500 text-xs uppercase tracking-wider">Processing...</span>
        </div>
    </div>
    
    <!-- Input Area -->
    <div class="input-area">
        <div class="relative">
            <div class="flex items-center gap-2">
                <span class="text-orange-600 font-mono text-sm font-bold">></span>
                <input
                    type="text"
                    id="commandInput"
                    class="command-input"
                    placeholder="ENTER COMMAND..."
                    autocomplete="off"
                    spellcheck="false"
                >
                <button onclick="clearChat()" class="text-gray-600 hover:text-gray-400 text-xs px-2 py-1.5 border border-gray-800 hover:border-gray-600 transition-colors uppercase">
                    Clr
                </button>
            </div>
            
            <div id="autocompleteDropdown" class="autocomplete-dropdown"></div>
        </div>
        
        <div class="quick-buttons">
            <button onclick="executeQuickCommand('WEI')" class="quick-btn">WEI</button>
            <button onclick="executeQuickCommand('GP')" class="quick-btn">GP</button>
            <button onclick="executeQuickCommand('STX')" class="quick-btn">STX</button>
            <button onclick="executeQuickCommand('CRYP')" class="quick-btn">CRYP</button>
            <button onclick="executeQuickCommand('BOND')" class="quick-btn">BOND</button>
            <button onclick="executeQuickCommand('TOP')" class="quick-btn">TOP</button>
            <button onclick="executeQuickCommand('ECO')" class="quick-btn">ECO</button>
            <button onclick="executeQuickCommand('SECF')" class="quick-btn">SECF</button>
            <button onclick="executeQuickCommand('ETF')" class="quick-btn">ETF</button>
            <button onclick="executeQuickCommand('GO AAPL')" class="quick-btn">GO AAPL</button>
            <button onclick="executeQuickCommand('GO TSLA')" class="quick-btn">GO TSLA</button>
            <button onclick="executeQuickCommand('HELP')" class="quick-btn">HELP</button>
        </div>
    </div>

    <script>
        // Clock
        function updateClock() {
            const now = new Date();
            document.getElementById('clock').textContent = now.toLocaleTimeString('en-US', {hour12: false});
        }
        setInterval(updateClock, 1000);
        updateClock();

        // Ticker Symbols
        const TICKER_SYMBOLS = [
            { symbol: '^GSPC', name: 'SPX', flag: 'US' },
            { symbol: '^NDX', name: 'NDX', flag: 'US' },
            { symbol: '^DJI', name: 'DJI', flag: 'US' },
            { symbol: '^VIX', name: 'VIX', flag: 'US' },
            { symbol: '^FTSE', name: 'UKX', flag: 'UK' },
            { symbol: '^N225', name: 'NKY', flag: 'JP' },
            { symbol: 'EURUSD=X', name: 'EUR/USD', flag: 'FX' },
            { symbol: 'GC=F', name: 'GOLD', flag: 'GC' },
            { symbol: 'CL=F', name: 'OIL', flag: 'CL' },
            { symbol: 'BTC-USD', name: 'BTC', flag: 'BTC' },
            { symbol: 'TLT', name: 'TLT', flag: 'US' },
            { symbol: 'DXY', name: 'DXY', flag: 'US' }
        ];

        async function initTicker() {
            const tickerTape = document.getElementById('tickerTape');
            let tickerHTML = '';
            
            for (let i = 0; i < 2; i++) {
                for (const item of TICKER_SYMBOLS) {
                    tickerHTML += `
                        <div class="ticker-item" onclick="executeQuickCommand('GO ${item.symbol}')">
                            <span class="text-gray-500 mr-1">${item.flag}</span>
                            <span class="text-gray-400 mr-2 font-bold">${item.name}</span>
                            <span class="text-gray-300 font-mono" id="ticker-${item.symbol}">--</span>
                            <span class="ml-1.5 text-xs" id="change-${item.symbol}">--</span>
                        </div>
                    `;
                }
            }
            
            tickerTape.innerHTML = tickerHTML;
            await updateTickerData();
            setInterval(updateTickerData, 30000);
            updateDashboard();
            setInterval(updateDashboard, 30000);
        }

        async function updateTickerData() {
            for (const item of TICKER_SYMBOLS) {
                try {
                    const data = await fetchTicker(item.symbol);
                    const price = data.main_info?.currentPrice || '--';
                    const change = data.main_info?.oneDayChange || '--';
                    const changeNum = parseFloat(change);
                    const colorClass = changeNum >= 0 ? 'text-green-500' : 'text-red-500';
                    const arrow = changeNum >= 0 ? '+' : '';
                    
                    const priceEl = document.getElementById(`ticker-${item.symbol}`);
                    const changeEl = document.getElementById(`change-${item.symbol}`);
                    
                    if (priceEl) priceEl.textContent = typeof price === 'number' ? price.toFixed(2) : price;
                    if (changeEl) {
                        changeEl.textContent = `${arrow}${changeNum.toFixed(2)}%`;
                        changeEl.className = `ml-1.5 text-xs ${colorClass}`;
                    }
                } catch (e) {
                    console.log(`Ticker update failed for ${item.symbol}:`, e);
                }
            }
        }
        
        async function updateDashboard() {
            try {
                const spData = await fetchTicker('^GSPC');
                const spChange = parseFloat(spData.main_info?.oneDayChange || 0);
                document.getElementById('dash-sp500').textContent = spData.main_info.currentPrice?.toFixed(2) || '--';
                const spChangeEl = document.getElementById('dash-sp500-change');
                spChangeEl.textContent = `${spChange >= 0 ? '+' : ''}${spChange.toFixed(2)}%`;
                spChangeEl.className = `text-xs ${spChange >= 0 ? 'text-green-500' : 'text-red-500'} font-mono`;
            } catch(e) {}
            
            try {
                const ndxData = await fetchTicker('^NDX');
                const ndxChange = parseFloat(ndxData.main_info?.oneDayChange || 0);
                document.getElementById('dash-nasdaq').textContent = ndxData.main_info.currentPrice?.toFixed(2) || '--';
                const ndxChangeEl = document.getElementById('dash-nasdaq-change');
                ndxChangeEl.textContent = `${ndxChange >= 0 ? '+' : ''}${ndxChange.toFixed(2)}%`;
                ndxChangeEl.className = `text-xs ${ndxChange >= 0 ? 'text-green-500' : 'text-red-500'} font-mono`;
            } catch(e) {}
            
            try {
                const vixData = await fetchTicker('^VIX');
                document.getElementById('dash-vix').textContent = vixData.main_info.currentPrice?.toFixed(2) || '--';
            } catch(e) {}
            
            try {
                const btcData = await fetchTicker('BTC-USD');
                const btcChange = parseFloat(btcData.main_info?.oneDayChange || 0);
                document.getElementById('dash-btc').textContent = btcData.main_info.currentPrice?.toLocaleString('en-US', {style: 'currency', currency: 'USD', maximumFractionDigits: 0}) || '--';
                const btcChangeEl = document.getElementById('dash-btc-change');
                btcChangeEl.textContent = `${btcChange >= 0 ? '+' : ''}${btcChange.toFixed(2)}%`;
                btcChangeEl.className = `text-xs ${btcChange >= 0 ? 'text-green-500' : 'text-red-500'} font-mono`;
            } catch(e) {}
            
            const sectors = [
                {ticker: 'XLK', name: 'TECH'},
                {ticker: 'XLF', name: 'FIN'},
                {ticker: 'XLV', name: 'HLTH'},
                {ticker: 'XLE', name: 'ENRG'},
                {ticker: 'XLY', name: 'DISC'},
                {ticker: 'XLI', name: 'IND'}
            ];
            
            let sectorHtml = '';
            for (const sec of sectors) {
                try {
                    const data = await fetchTicker(sec.ticker);
                    const change = parseFloat(data.main_info?.oneDayChange || 0);
                    const color = change >= 0 ? 'text-green-500' : 'text-red-500';
                    sectorHtml += `
                        <div class="text-center p-1.5 bg-black rounded border border-gray-800 hover:border-gray-700 cursor-pointer" onclick="executeQuickCommand('GO ${sec.ticker}')">
                            <div class="text-xs text-gray-500 font-mono uppercase">${sec.name}</div>
                            <div class="text-xs ${color} font-mono">${change >= 0 ? '+' : ''}${change.toFixed(2)}%</div>
                        </div>
                    `;
                } catch(e) {
                    sectorHtml += `
                        <div class="text-center p-1.5 bg-black rounded border border-gray-800">
                            <div class="text-xs text-gray-500 font-mono uppercase">${sec.name}</div>
                            <div class="text-xs text-gray-600">--</div>
                        </div>
                    `;
                }
            }
            document.getElementById('sector-miniview').innerHTML = sectorHtml;

            await loadWelcomeNews();
        }

        async function loadWelcomeNews() {
            try {
                const data = await fetchTicker('SPY');
                if (data.recent_news && data.recent_news.length > 0) {
                    const newsContainer = document.getElementById('welcome-news-section');
                    const newsList = document.getElementById('welcome-news-list');
                    
                    let html = '';
                    data.recent_news.slice(0, 5).forEach(item => {
                        const date = new Date(item.pubDate);
                        const hoursAgo = Math.floor((Date.now() - date) / 3600000);
                        const timeStr = hoursAgo < 1 ? 'NOW' : hoursAgo < 24 ? `${hoursAgo}H` : `${Math.floor(hoursAgo/24)}D`;
                        
                        html += `
                            <div class="flex justify-between items-start gap-2 py-1.5 border-b border-gray-800/50 last:border-0 cursor-pointer hover:bg-gray-900/30 px-1" onclick="window.open('${item.source_url || '#'}', '_blank')">
                                <div class="text-gray-300 text-xs line-clamp-1 flex-1">${item.title}</div>
                                <div class="flex items-center gap-2 flex-shrink-0">
                                    <span class="text-gray-600 text-xs uppercase">${item.provider}</span>
                                    <span class="text-gray-500 text-xs font-mono">${timeStr}</span>
                                </div>
                            </div>
                        `;
                    });
                    
                    newsList.innerHTML = html;
                    newsContainer.style.display = 'block';
                }
            } catch (e) {
                console.log('Failed to load welcome news:', e);
            }
        }

        const commandInput = document.getElementById('commandInput');
        const chatContainer = document.getElementById('chatContainer');
        const chatHistory = document.getElementById('chatHistory');
        const loadingIndicator = document.getElementById('loadingIndicator');
        const welcomeMessage = document.getElementById('welcomeMessage');
        const autocompleteDropdown = document.getElementById('autocompleteDropdown');
        let commandHistory = [];
        let historyIndex = -1;
        
        const COMMANDS = [
            'WEI', 'GP', 'TOP', 'ECO', 'SECF', 'ETF', 'STX', 'CRYP', 'BOND', 'HELP', 'CLEAR', 'GO'
        ];
        
        const TICKERS = ['AAPL', 'MSFT', 'GOOGL', 'AMZN', 'TSLA', 'NVDA', 'META', 'NFLX', 'AMD', 'INTC',
                        'JPM', 'SOFI', 'COIN', 'BMNR', 'HOOD',
                        'BEAM', 'EXAS', 'UNH', 'RKLB', 'ASTS',
                        'NEE', 'RIVN', 'NIO', 'XPEV',
                        'IREN', 'NBIS', 'IONQ', 'QBTS', 'RGTI',
                        'ARKK', 'QTUM', 'SMH', 'ICLN', 'ARKX'];

        commandInput.addEventListener('input', function(e) {
            const value = this.value.toUpperCase();
            if (!value) {
                autocompleteDropdown.style.display = 'none';
                return;
            }
            const matches = [...COMMANDS, ...TICKERS].filter(cmd =>
                cmd.startsWith(value) && cmd !== value
            ).slice(0, 8);
            if (matches.length > 0) {
                autocompleteDropdown.innerHTML = matches.map((match, index) =>
                    `<div class="autocomplete-item ${index === 0 ? 'selected' : ''}" onclick="selectAutocomplete('${match}')">${match}</div>`
                ).join('');
                autocompleteDropdown.style.display = 'block';
            } else {
                autocompleteDropdown.style.display = 'none';
            }
        });

        commandInput.addEventListener('keydown', function(e) {
            const items = autocompleteDropdown.querySelectorAll('.autocomplete-item');
            let selectedIndex = Array.from(items).findIndex(item => item.classList.contains('selected'));
            if (e.key === 'ArrowDown') {
                e.preventDefault();
                if (selectedIndex < items.length - 1) {
                    items[selectedIndex]?.classList.remove('selected');
                    items[selectedIndex + 1]?.classList.add('selected');
                }
            } else if (e.key === 'ArrowUp') {
                e.preventDefault();
                if (selectedIndex > 0) {
                    items[selectedIndex]?.classList.remove('selected');
                    items[selectedIndex - 1]?.classList.add('selected');
                }
            } else if (e.key === 'Tab' && selectedIndex >= 0) {
                e.preventDefault();
                selectAutocomplete(items[selectedIndex].textContent);
            } else if (e.key === 'Enter') {
                autocompleteDropdown.style.display = 'none';
            } else if (e.key === 'Escape') {
                autocompleteDropdown.style.display = 'none';
            }
        });

        function selectAutocomplete(value) {
            const currentValue = commandInput.value;
            const lastSpace = currentValue.lastIndexOf(' ');
            if (lastSpace >= 0) {
                commandInput.value = currentValue.substring(0, lastSpace + 1) + value;
            } else {
                commandInput.value = value;
            }
            autocompleteDropdown.style.display = 'none';
            commandInput.focus();
        }

        document.addEventListener('click', function(e) {
            if (!e.target.closest('.input-area')) {
                autocompleteDropdown.style.display = 'none';
            }
        });

        function executeQuickCommand(cmd) {
            commandInput.value = cmd;
            executeCommand(cmd);
        }

        function clearChat() {
            chatHistory.innerHTML = '';
            welcomeMessage.style.display = 'block';
        }

        function addMessage(html, isError = false) {
            welcomeMessage.style.display = 'none';
            const messageDiv = document.createElement('div');
            messageDiv.className = 'chat-message';
            
            const timestamp = new Date().toLocaleTimeString('en-US', {hour12: false});
            const cmdText = commandInput.value || 'SYSTEM';
            
            messageDiv.innerHTML = `
                <div class="command-line">
                    <span class="timestamp">[${timestamp}]</span>
                    <span class="text-gray-500">></span>
                    <span class="${isError ? 'text-red-500' : 'text-gray-500'}">${cmdText}</span>
                </div>
                <div>
                    ${html}
                </div>
            `;
            
            chatHistory.appendChild(messageDiv);
            scrollToBottom();
        }

        function scrollToBottom() {
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        const API_BASE = 'https://mini-finapi.vercel.app/api';
        const CORS_PROXIES = [
            'https://api.allorigins.win/raw?url=',
            'https://corsproxy.io/?',
            'https://api.codetabs.com/v1/proxy?quest='
        ];

        async function fetchWithCORS(url) {
            try {
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 10000);
                
                const response = await fetch(url, {
                    signal: controller.signal,
                    headers: { 'Accept': 'application/json' }
                });
                
                clearTimeout(timeoutId);
                if (response.ok) return await response.json();
            } catch (e) {
                console.log('Direct fetch failed, trying proxies...');
            }
            
            for (const proxy of CORS_PROXIES) {
                try {
                    const proxyUrl = proxy + encodeURIComponent(url);
                    const controller = new AbortController();
                    const timeoutId = setTimeout(() => controller.abort(), 15000);
                    
                    const response = await fetch(proxyUrl, {
                        signal: controller.signal,
                        headers: { 'Accept': 'application/json' }
                    });
                    
                    clearTimeout(timeoutId);
                    if (response.ok) {
                        const data = await response.json();
                        if (data && data.ticker) return data;
                    }
                } catch (e) {
                    continue;
                }
            }
            throw new Error('API unavailable');
        }

        async function fetchTicker(ticker) {
            const url = `${API_BASE}/ticker?ticker=${encodeURIComponent(ticker)}`;
            return await fetchWithCORS(url);
        }

        commandInput.addEventListener('keydown', async (e) => {
            if (e.key === 'Enter') {
                const cmd = commandInput.value.trim().toUpperCase();
                if (!cmd) return;
                
                commandHistory.push(cmd);
                historyIndex = commandHistory.length;
                autocompleteDropdown.style.display = 'none';
                
                await executeCommand(cmd);
                commandInput.value = '';
            } else if (e.key === 'ArrowUp') {
                e.preventDefault();
                if (historyIndex > 0) {
                    historyIndex--;
                    commandInput.value = commandHistory[historyIndex];
                }
            } else if (e.key === 'ArrowDown') {
                e.preventDefault();
                if (historyIndex < commandHistory.length - 1) {
                    historyIndex++;
                    commandInput.value = commandHistory[historyIndex];
                } else {
                    historyIndex = commandHistory.length;
                    commandInput.value = '';
                }
            }
        });

        async function executeCommand(cmd) {
            loadingIndicator.classList.remove('hidden');
            scrollToBottom();
            const parts = cmd.split(' ');
            const baseCmd = parts[0];
            const arg = parts[1] || '';
            try {
                switch(baseCmd) {
                    case 'WEI':
                        await loadWorldIndices();
                        break;
                    case 'GP':
                        await loadGlobalPerformance();
                        break;
                    case 'TOP':
                        await loadTopNews();
                        break;
                    case 'ECO':
                        await loadEconomicCalendar();
                        break;
                    case 'SECF':
                        await loadSectorPerformance();
                        break;
                    case 'GO':
                        if (!arg) throw new Error('USAGE: GO TICKER');
                        await loadFullAnalysis(arg);
                        break;
                    case 'ETF':
                        await loadETFView();
                        break;
                    case 'STX':
                        await loadStockMatrix();
                        break;
                    case 'CRYP':
                        await loadCryptoView();
                        break;
                    case 'BOND':
                        await loadBondOutlook();
                        break;
                    case 'CLEAR':
                    case 'CLS':
                        clearChat();
                        break;
                    case 'HELP':
                        showHelp();
                        break;
                    default:
                        throw new Error(`UNKNOWN COMMAND: ${baseCmd}`);
                }
            } catch (error) {
                console.error('Command Error:', error);
                addMessage(`<div class="text-red-500 text-xs font-mono p-2 uppercase">${error.message}</div>`, true);
            } finally {
                loadingIndicator.classList.add('hidden');
            }
        }

        function showHelp() {
            addMessage(`
                <div class="text-gray-500 font-mono text-xs p-3">
                    <div class="text-gray-400 mb-2 text-xs uppercase tracking-widest font-bold">Available Commands</div>
                    <div class="grid grid-cols-3 gap-1 text-xs">
                        <div class="p-1.5"><span class="text-orange-600 font-bold">GO</span> TICKER - Full Analysis</div>
                        <div class="p-1.5"><span class="text-orange-600 font-bold">WEI</span> World Indices</div>
                        <div class="p-1.5"><span class="text-orange-600 font-bold">GP</span> Global Perf</div>
                        <div class="p-1.5"><span class="text-orange-600 font-bold">STX</span> Stock Matrix</div>
                        <div class="p-1.5"><span class="text-orange-600 font-bold">CRYP</span> Crypto</div>
                        <div class="p-1.5"><span class="text-orange-600 font-bold">BOND</span> Rates</div>
                        <div class="p-1.5"><span class="text-orange-600 font-bold">TOP</span> News</div>
                        <div class="p-1.5"><span class="text-orange-600 font-bold">ECO</span> Econ Calendar</div>
                        <div class="p-1.5"><span class="text-orange-600 font-bold">SECF</span> Sectors</div>
                        <div class="p-1.5"><span class="text-orange-600 font-bold">ETF</span> Thematic ETFs</div>
                        <div class="p-1.5"><span class="text-orange-600 font-bold">CLEAR</span> Clear screen</div>
                    </div>
                </div>
            `);
        }

        async function loadFullAnalysis(ticker) {
            const data = await fetchTicker(ticker);
            const info = data.main_info;
            const price = data.price_performance;
            const change = parseFloat(info.oneDayChange || 0);
            const isPos = change >= 0;
            
            // Determine exchange prefix for TradingView
            let exchange = 'NASDAQ';
            if (ticker.includes('.')) {
                exchange = 'LSE';
            } else if (['^GSPC', '^NDX', '^DJI', '^VIX', '^RUT'].includes(ticker)) {
                exchange = 'INDEX';
            } else if (['BTC-USD', 'ETH-USD'].includes(ticker)) {
                exchange = 'CRYPTO';
            } else if (['GC=F', 'SI=F', 'CL=F', 'NG=F'].includes(ticker)) {
                exchange = 'COMEX';
            }
            
            const tvSymbol = exchange === 'INDEX' ? ticker : 
                            exchange === 'CRYPTO' ? `BINANCE:${ticker.replace('-USD', 'USDT')}` :
                            exchange === 'COMEX' ? `COMEX:${ticker.replace('=F', '')}` :
                            `${exchange}:${ticker}`;
            
            // Recommendation badge
            let recClass = 'rec-hold';
            let recKey = (data.price_targets.recommendationKey || 'hold').toLowerCase();
            if (recKey.includes('buy')) recClass = 'rec-buy';
            else if (recKey.includes('sell')) recClass = 'rec-sell';
            
            // Helper for dynamic card styling
            const getDynamicClass = (value, threshold = 0) => {
                const num = parseFloat(value);
                if (isNaN(num)) return '';
                if (num > threshold) return 'card-dynamic-positive';
                if (num < threshold) return 'card-dynamic-negative';
                return '';
            };
            
            let html = `
                <!-- Header Section -->
                <div class="panel mb-4">
                    <div class="panel-header">
                        <div>
                            <div class="flex items-center gap-2">
                                <span class="text-gray-200 font-mono text-xl font-bold">${info.shortName || ticker}</span>
                                <span class="px-2 py-0.5 bg-orange-600/20 text-orange-600 text-xs font-bold font-mono">${ticker}</span>
                                <span class="text-gray-500 text-xs uppercase">${info.sector || 'N/A'}</span>
                            </div>
                            <div class="text-gray-600 text-xs mt-1">${data.company_info.industry || ''} â€¢ ${data.company_info.city || ''}</div>
                        </div>
                        <div class="text-right">
                            <div class="text-3xl text-gray-200 font-mono font-bold">$${info.currentPrice?.toFixed(2) || '--'}</div>
                            <div class="text-sm ${isPos ? 'text-green-500' : 'text-red-500'} font-mono font-bold">
                                ${isPos ? '+' : ''}${change.toFixed(2)}% Today
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- TradingView Chart -->
                <div class="tradingview-widget-container" id="tv-chart-${ticker}"></div>
                
                <!-- Key Metrics Grid -->
                <div class="grid-section grid-6 mb-4">
                    <div class="metric-card ${getDynamicClass(info.marketCap)} p-3">
                        <div class="text-gray-500 text-xs uppercase mb-1">Mkt Cap</div>
                        <div class="text-gray-200 font-mono font-bold">${info.marketCap || '--'}</div>
                    </div>
                    <div class="metric-card ${getDynamicClass(15 - (info.PE || 0))} p-3">
                        <div class="text-gray-500 text-xs uppercase mb-1">P/E TTM</div>
                        <div class="text-gray-200 font-mono font-bold">${info.PE?.toFixed(1) || '--'}</div>
                    </div>
                    <div class="metric-card ${getDynamicClass(15 - (info.forwardPE || 0))} p-3">
                        <div class="text-gray-500 text-xs uppercase mb-1">Fwd P/E</div>
                        <div class="text-gray-200 font-mono font-bold">${info.forwardPE?.toFixed(1) || '--'}</div>
                    </div>
                    <div class="metric-card p-3">
                        <div class="text-gray-500 text-xs uppercase mb-1">P/S</div>
                        <div class="text-gray-200 font-mono font-bold">${info.PS?.toFixed(1) || '--'}</div>
                    </div>
                    <div class="metric-card ${getDynamicClass((data.price_targets.targetMeanPrice || 0) - info.currentPrice)} p-3">
                        <div class="text-gray-500 text-xs uppercase mb-1">Target</div>
                        <div class="text-gray-200 font-mono font-bold">$${data.price_targets.targetMeanPrice?.toFixed(0) || '--'}</div>
                    </div>
                    <div class="metric-card p-3">
                        <div class="text-gray-500 text-xs uppercase mb-1">Analyst Rec</div>
                        <div class="${recClass} recommendation-badge">${data.price_targets.recommendationKey || '--'}</div>
                    </div>
                </div>
                
                <!-- Price Performance Section -->
                <div class="panel mb-4 p-3">
                    <div class="section-title mb-3">Price Performance</div>
                    <div class="grid-section grid-2">
                        <div>
                            <div class="flex justify-between text-xs text-gray-500 mb-1 uppercase">
                                <span>Day Range</span>
                                <span class="text-gray-400 font-mono">$${price.dayLow?.toFixed(2)} - $${price.dayHigh?.toFixed(2)}</span>
                            </div>
                            <div class="range-bar">
                                <div class="range-fill" style="width: ${((info.currentPrice - price.dayLow) / (price.dayHigh - price.dayLow) * 100) || 0}%"></div>
                            </div>
                        </div>
                        <div>
                            <div class="flex justify-between text-xs text-gray-500 mb-1 uppercase">
                                <span>52W Range</span>
                                <span class="text-gray-400 font-mono">$${price.fiftyTwoWeekLow?.toFixed(2)} - $${price.fiftyTwoWeekHigh?.toFixed(2)}</span>
                            </div>
                            <div class="range-bar">
                                <div class="range-fill" style="width: ${((info.currentPrice - price.fiftyTwoWeekLow) / (price.fiftyTwoWeekHigh - price.fiftyTwoWeekLow) * 100) || 0}%"></div>
                                <div class="range-marker" style="left: ${((info.currentPrice - price.fiftyTwoWeekLow) / (price.fiftyTwoWeekHigh - price.fiftyTwoWeekLow) * 100) || 0}%"></div>
                            </div>
                        </div>
                    </div>
                    <div class="grid-section grid-4 mt-3">
                        <div class="text-center p-2 border border-gray-800">
                            <div class="text-gray-600 text-xs uppercase">50 DMA</div>
                            <div class="text-gray-300 font-mono font-bold">$${price.fiftyDayAverage?.toFixed(2) || '--'}</div>
                            <div class="${parseFloat(price.change_from_50DMA || 0) >= 0 ? 'text-green-500' : 'text-red-500'} text-xs">${price.change_from_50DMA || '--'}</div>
                        </div>
                        <div class="text-center p-2 border border-gray-800">
                            <div class="text-gray-600 text-xs uppercase">200 DMA</div>
                            <div class="text-gray-300 font-mono font-bold">$${price.twoHundredDayAverage?.toFixed(2) || '--'}</div>
                            <div class="${parseFloat(price.change_from_200DMA || 0) >= 0 ? 'text-green-500' : 'text-red-500'} text-xs">${price.change_from_200DMA || '--'}</div>
                        </div>
                        <div class="text-center p-2 border border-gray-800">
                            <div class="text-gray-600 text-xs uppercase">Volume</div>
                            <div class="text-gray-300 font-mono font-bold">${(info.volume / 1e6).toFixed(1)}M</div>
                            <div class="text-gray-500 text-xs">Avg: ${(info.averageVolume / 1e6).toFixed(1)}M</div>
                        </div>
                        <div class="text-center p-2 border border-gray-800">
                            <div class="text-gray-600 text-xs uppercase">Beta</div>
                            <div class="text-gray-300 font-mono font-bold">${info.beta?.toFixed(2) || '--'}</div>
                            <div class="text-gray-500 text-xs">Volatility</div>
                        </div>
                    </div>
                </div>
                
                <!-- Valuation & Growth Grid -->
                <div class="grid-section grid-2 mb-4">
                    <div class="panel p-3">
                        <div class="section-title mb-2">Valuation</div>
                        <div class="compact-stat">
                            <span class="text-gray-500 text-xs uppercase">EV/EBITDA</span>
                            <span class="text-gray-300 font-mono">${data.valuation.enterpriseToEbitda?.toFixed(1) || '--'}</span>
                        </div>
                        <div class="compact-stat">
                            <span class="text-gray-500 text-xs uppercase">Price/Book</span>
                            <span class="text-gray-300 font-mono">${data.valuation.priceToBook?.toFixed(1) || '--'}</span>
                        </div>
                        <div class="compact-stat">
                            <span class="text-gray-500 text-xs uppercase">Price/Cash</span>
                            <span class="text-gray-300 font-mono">${data.valuation.priceToCashflow?.toFixed(1) || '--'}</span>
                        </div>
                        <div class="compact-stat">
                            <span class="text-gray-500 text-xs uppercase">Enterprise Value</span>
                            <span class="text-gray-300 font-mono">${data.valuation.enterpriseValue || '--'}</span>
                        </div>
                        <div class="compact-stat">
                            <span class="text-gray-500 text-xs uppercase">Book Value/Sh</span>
                            <span class="text-gray-300 font-mono">$${data.valuation.bookValue?.toFixed(2) || '--'}</span>
                        </div>
                    </div>
                    
                    <div class="panel p-3">
                        <div class="section-title mb-2">Growth Metrics</div>
                        <div class="compact-stat">
                            <span class="text-gray-500 text-xs uppercase">Revenue Growth</span>
                            <span class="${parseFloat(data.growth.revenueGrowth || 0) >= 0 ? 'text-green-500' : 'text-red-500'} font-mono">${data.growth.revenueGrowth || '--'}</span>
                        </div>
                        <div class="compact-stat">
                            <span class="text-gray-500 text-xs uppercase">Earnings Growth</span>
                            <span class="${parseFloat(data.growth.earningsGrowth || 0) >= 0 ? 'text-green-500' : 'text-red-500'} font-mono">${data.growth.earningsGrowth || '--'}</span>
                        </div>
                        <div class="compact-stat">
                            <span class="text-gray-500 text-xs uppercase">EPS Growth</span>
                            <span class="${parseFloat(data.growth.epsGrowth || 0) >= 0 ? 'text-green-500' : 'text-red-500'} font-mono">${data.growth.epsGrowth || '--'}</span>
                        </div>
                        <div class="compact-stat">
                            <span class="text-gray-500 text-xs uppercase">PEG Ratio</span>
                            <span class="text-gray-300 font-mono">${data.growth.pegRatio || '--'}</span>
                        </div>
                        <div class="compact-stat">
                            <span class="text-gray-500 text-xs uppercase">Total Revenue</span>
                            <span class="text-gray-300 font-mono">${data.growth.totalRevenue || '--'}</span>
                        </div>
                    </div>
                </div>
                
                <!-- Profitability & Financial Health -->
                <div class="grid-section grid-2 mb-4">
                    <div class="panel p-3">
                        <div class="section-title mb-2">Profitability</div>
                        <div class="grid-section grid-2">
                            <div class="text-center p-2 border border-gray-800 ${getDynamicClass(parseFloat(data.returns.grossMargins || 0) - 0.2)}">
                                <div class="text-gray-600 text-xs uppercase">Gross Margin</div>
                                <div class="text-gray-200 font-mono font-bold">${data.returns.grossMargins || '--'}</div>
                            </div>
                            <div class="text-center p-2 border border-gray-800 ${getDynamicClass(parseFloat(data.returns.operatingMargins || 0) - 0.15)}">
                                <div class="text-gray-600 text-xs uppercase">Operating Margin</div>
                                <div class="text-gray-200 font-mono font-bold">${data.returns.operatingMargins || '--'}</div>
                            </div>
                            <div class="text-center p-2 border border-gray-800 ${getDynamicClass(parseFloat(data.returns.profitMargins || 0) - 0.1)}">
                                <div class="text-gray-600 text-xs uppercase">Profit Margin</div>
                                <div class="text-gray-200 font-mono font-bold">${data.returns.profitMargins || '--'}</div>
                            </div>
                            <div class="text-center p-2 border border-gray-800">
                                <div class="text-gray-600 text-xs uppercase">EBITDA Margin</div>
                                <div class="text-gray-200 font-mono font-bold">${data.returns.ebitdaMargins || '--'}</div>
                            </div>
                        </div>
                        <div class="compact-stat mt-2">
                            <span class="text-gray-500 text-xs uppercase">Return on Assets</span>
                            <span class="text-gray-300 font-mono">${data.returns.returnOnAssets || '--'}</span>
                        </div>
                        <div class="compact-stat">
                            <span class="text-gray-500 text-xs uppercase">Return on Equity</span>
                            <span class="text-gray-300 font-mono">${data.returns.returnOnEquity || '--'}</span>
                        </div>
                    </div>
                    
                    <div class="panel p-3">
                        <div class="section-title mb-2">Financial Health</div>
                        <div class="grid-section grid-2">
                            <div class="text-center p-2 border border-gray-800 ${getDynamicClass((data.ratios.currentRatio || 0) - 1.5)}">
                                <div class="text-gray-600 text-xs uppercase">Current Ratio</div>
                                <div class="text-gray-200 font-mono font-bold">${data.ratios.currentRatio?.toFixed(2) || '--'}</div>
                            </div>
                            <div class="text-center p-2 border border-gray-800 ${getDynamicClass((data.ratios.quickRatio || 0) - 1)}">
                                <div class="text-gray-600 text-xs uppercase">Quick Ratio</div>
                                <div class="text-gray-200 font-mono font-bold">${data.ratios.quickRatio?.toFixed(2) || '--'}</div>
                            </div>
                            <div class="text-center p-2 border border-gray-800 ${getDynamicClass(100 - (data.ratios.debtToEquity || 0))}">
                                <div class="text-gray-600 text-xs uppercase">Debt/Equity</div>
                                <div class="text-gray-200 font-mono font-bold">${data.ratios.debtToEquity?.toFixed(1) || '--'}</div>
                            </div>
                            <div class="text-center p-2 border border-gray-800 ${getDynamicClass((data.ratios.interestCoverage || 0) - 3)}">
                                <div class="text-gray-600 text-xs uppercase">Interest Coverage</div>
                                <div class="text-gray-200 font-mono font-bold">${data.ratios.interestCoverage?.toFixed(1) || '--'}</div>
                            </div>
                        </div>
                        <div class="compact-stat mt-2">
                            <span class="text-gray-500 text-xs uppercase">Total Cash</span>
                            <span class="text-green-500 font-mono font-bold">${data.debt.totalCash || '--'}</span>
                        </div>
                        <div class="compact-stat">
                            <span class="text-gray-500 text-xs uppercase">Free Cash Flow</span>
                            <span class="text-green-500 font-mono font-bold">${data.debt.freeCashflow || '--'}</span>
                        </div>
                    </div>
                </div>
                
                <!-- Risk & Earnings -->
                <div class="grid-section grid-2 mb-4">
                    <div class="panel p-3">
                        <div class="section-title mb-2">Risk Metrics</div>
                        <div class="grid-section grid-3">
                            <div class="text-center p-2 border border-gray-800">
                                <div class="text-gray-600 text-xs uppercase">Beta</div>
                                <div class="text-gray-200 font-mono font-bold">${data.risk.beta?.toFixed(2) || '--'}</div>
                            </div>
                            <div class="text-center p-2 border border-gray-800">
                                <div class="text-gray-600 text-xs uppercase">Overall Risk</div>
                                <div class="text-gray-200 font-mono font-bold">${data.risk.overallRisk || '--'}</div>
                            </div>
                            <div class="text-center p-2 border border-gray-800">
                                <div class="text-gray-600 text-xs uppercase">Audit Risk</div>
                                <div class="text-gray-200 font-mono font-bold">${data.risk.auditRisk || '--'}</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="panel p-3">
                        <div class="section-title mb-2">Earnings</div>
                        <div class="grid-section grid-2">
                            <div class="text-center p-2 border border-gray-800">
                                <div class="text-gray-600 text-xs uppercase">EPS (TTM)</div>
                                <div class="text-gray-200 font-mono font-bold">${data.earnings.trailingEps?.toFixed(2) || '--'}</div>
                            </div>
                            <div class="text-center p-2 border border-gray-800">
                                <div class="text-gray-600 text-xs uppercase">EPS (Fwd)</div>
                                <div class="text-gray-200 font-mono font-bold">${data.earnings.forwardEps?.toFixed(2) || '--'}</div>
                            </div>
                        </div>
                        <div class="compact-stat mt-2">
                            <span class="text-gray-500 text-xs uppercase">Next Earnings</span>
                            <span class="text-gray-300 font-mono">${data.earnings_dates?.earningsDate || '--'}</span>
                        </div>
                    </div>
                </div>
                
                <!-- Analyst Targets -->
                <div class="panel mb-4 p-3">
                    <div class="section-title mb-2">Analyst Price Targets</div>
                    <div class="grid-section grid-4">
                        <div class="text-center p-3 border border-gray-800">
                            <div class="text-gray-600 text-xs uppercase">Low</div>
                            <div class="text-red-500 font-mono font-bold text-lg">$${data.price_targets.targetLowPrice?.toFixed(0) || '--'}</div>
                        </div>
                        <div class="text-center p-3 border border-gray-800 bg-orange-600/5">
                            <div class="text-orange-600 text-xs uppercase font-bold">Mean</div>
                            <div class="text-orange-600 font-mono font-bold text-xl">$${data.price_targets.targetMeanPrice?.toFixed(0) || '--'}</div>
                            <div class="${((data.price_targets.targetMeanPrice - info.currentPrice) / info.currentPrice * 100) >= 0 ? 'text-green-500' : 'text-red-500'} text-xs">
                                ${((data.price_targets.targetMeanPrice - info.currentPrice) / info.currentPrice * 100).toFixed(1)}% vs current
                            </div>
                        </div>
                        <div class="text-center p-3 border border-gray-800">
                            <div class="text-gray-600 text-xs uppercase">High</div>
                            <div class="text-green-500 font-mono font-bold text-lg">$${data.price_targets.targetHighPrice?.toFixed(0) || '--'}</div>
                        </div>
                        <div class="text-center p-3 border border-gray-800">
                            <div class="text-gray-600 text-xs uppercase">Analysts</div>
                            <div class="text-gray-200 font-mono font-bold text-lg">${data.price_targets.numberOfAnalystOpinions || '--'}</div>
                            <div class="text-gray-500 text-xs">Covering</div>
                        </div>
                    </div>
                </div>
                
                <!-- Description -->
                <div class="panel mb-4 p-3">
                    <div class="section-title mb-2">Business Description</div>
                    <div class="text-gray-500 text-xs leading-relaxed" style="max-height: 100px; overflow-y: auto;">
                        ${data.company_business.longBusinessSummary || 'No description available.'}
                    </div>
                </div>
            `;
            
            // Add news if available
            if (data.recent_news && data.recent_news.length > 0) {
                html += `
                    <div class="panel mb-4">
                        <div class="panel-header">
                            <div class="section-title">Recent News</div>
                        </div>
                        <div class="p-2">
                `;
                data.recent_news.slice(0, 5).forEach(item => {
                    const date = new Date(item.pubDate);
                    const hoursAgo = Math.floor((Date.now() - date) / 3600000);
                    const timeStr = hoursAgo < 1 ? 'NOW' : hoursAgo < 24 ? `${hoursAgo}H` : `${Math.floor(hoursAgo/24)}D`;
                    
                    html += `
                        <div class="news-item" onclick="window.open('${item.source_url || '#'}', '_blank')">
                            <div class="flex justify-between items-start gap-2">
                                <div class="text-gray-300 text-xs flex-1">${item.title}</div>
                                <div class="flex items-center gap-2 flex-shrink-0">
                                    <span class="text-gray-600 text-xs uppercase">${item.provider}</span>
                                    <span class="text-gray-500 text-xs font-mono">${timeStr}</span>
                                </div>
                            </div>
                        </div>
                    `;
                });
                html += `</div></div>`;
            }
            
            addMessage(html);
            
            // Load TradingView widget
            setTimeout(() => {
                loadTradingViewWidget(ticker, tvSymbol);
            }, 100);
        }

        function loadTradingViewWidget(ticker, symbol) {
            const container = document.getElementById(`tv-chart-${ticker}`);
            if (!container) return;
            
            container.innerHTML = '';
            
            const script = document.createElement('script');
            script.src = 'https://s3.tradingview.com/external-embedding/embed-widget-advanced-chart.js';
            script.async = true;
            script.innerHTML = JSON.stringify({
                "allow_symbol_change": true,
                "calendar": false,
                "details": false,
                "hide_side_toolbar": false,
                "hide_top_toolbar": false,
                "hide_legend": false,
                "hide_volume": false,
                "hotlist": false,
                "interval": "D",
                "locale": "en",
                "save_image": true,
                "style": "1",
                "symbol": symbol,
                "theme": "dark",
                "timezone": "Etc/UTC",
                "backgroundColor": "#111111",
                "gridColor": "rgba(255, 102, 0, 0.1)",
                "watchlist": [],
                "withdateranges": true,
                "compareSymbols": [],
                "studies": ["Volume@tv-basicstudies"],
                "autosize": true
            });
            
            container.appendChild(script);
        }

        async function loadWorldIndices() {
            const indices = {
                'AMERICAS': [
                    {name: 'S&P 500', symbol: '^GSPC', flag: 'US'},
                    {name: 'NASDAQ 100', symbol: '^NDX', flag: 'US'},
                    {name: 'DOW JONES', symbol: '^DJI', flag: 'US'},
                    {name: 'RUSSELL 2000', symbol: '^RUT', flag: 'US'},
                    {name: 'VIX', symbol: '^VIX', flag: 'VX'},
                    {name: 'DXY', symbol: 'DX-Y.NYB', flag: 'DX'}
                ],
                'EUROPE': [
                    {name: 'FTSE 100', symbol: '^FTSE', flag: 'UK'},
                    {name: 'DAX 40', symbol: '^GDAXI', flag: 'DE'},
                    {name: 'CAC 40', symbol: '^FCHI', flag: 'FR'},
                    {name: 'EURO STOXX 50', symbol: '^STOXX50E', flag: 'EU'},
                    {name: 'FTSE MIB', symbol: '^FTSEMIB.MI', flag: 'IT'},
                    {name: 'IBEX 35', symbol: '^IBEX', flag: 'ES'}
                ],
                'ASIA-PACIFIC': [
                    {name: 'NIKKEI 225', symbol: '^N225', flag: 'JP'},
                    {name: 'HANG SENG', symbol: '^HSI', flag: 'HK'},
                    {name: 'SHANGHAI COMP', symbol: '000001.SS', flag: 'CN'},
                    {name: 'KOSPI', symbol: '^KS11', flag: 'KR'},
                    {name: 'ASX 200', symbol: '^AXJO', flag: 'AU'},
                    {name: 'SENSEX', symbol: '^BSESN', flag: 'IN'}
                ]
            };
            
            let html = `<div class="panel-header mb-2"><div class="section-title">WORLD EQUITY INDICES</div></div><div class="space-y-3">`;
            
            for (const [region, items] of Object.entries(indices)) {
                html += `<div><div class="text-gray-500 text-xs mb-1.5 uppercase tracking-wider font-bold">${region}</div><div class="grid grid-cols-2 md:grid-cols-3 gap-2">`;
                
                for (const item of items) {
                    try {
                        const data = await fetchTicker(item.symbol);
                        const change = parseFloat(data.main_info?.oneDayChange || 0);
                        const from200DMA = parseFloat(data.price_performance?.change_from_200DMA || 0);
                        const from50DMA = parseFloat(data.price_performance?.change_from_50DMA || 0);
                        const colorClass = change >= 0 ? 'value-up' : 'value-down';
                        
                        html += `
                            <div class="metric-card p-2.5 cursor-pointer hover:border-gray-700 transition-all ${change >= 0 ? 'positive' : 'negative'}" onclick="executeQuickCommand('GO ${item.symbol}')">
                                <div class="flex justify-between items-center mb-1">
                                    <span class="text-gray-400 text-xs uppercase font-bold">${item.name}</span>
                                    <span class="text-gray-600 text-xs">${item.flag}</span>
                                </div>
                                <div class="flex justify-between items-end">
                                    <div class="text-gray-300 font-mono text-sm font-bold">${data.main_info.currentPrice?.toFixed(2) || '--'}</div>
                                    <div class="text-xs ${colorClass} font-mono font-bold">${change >= 0 ? '+' : ''}${change.toFixed(2)}%</div>
                                </div>
                                <div class="flex justify-between text-xs mt-1.5 pt-1.5 border-t border-gray-800">
                                    <span class="text-gray-600 uppercase">50D: ${from50DMA >= 0 ? '+' : ''}${from50DMA.toFixed(1)}%</span>
                                    <span class="text-gray-600 uppercase">200D: ${from200DMA >= 0 ? '+' : ''}${from200DMA.toFixed(1)}%</span>
                                </div>
                            </div>
                        `;
                    } catch (e) {
                        html += `
                            <div class="panel p-2.5 opacity-50">
                                <div class="text-gray-500 text-xs uppercase">${item.name}</div>
                                <div class="text-red-500 text-xs">ERR</div>
                            </div>
                        `;
                    }
                }
                html += `</div></div>`;
            }
            html += `</div>`;
            addMessage(html);
        }

        async function loadGlobalPerformance() {
            const assets = [
                {name: 'BTC', ticker: 'BTC-USD', category: 'CRYPTO'},
                {name: 'ETH', ticker: 'ETH-USD', category: 'CRYPTO'},
                {name: 'GOLD', ticker: 'GC=F', category: 'COMM'},
                {name: 'SILVER', ticker: 'SI=F', category: 'COMM'},
                {name: 'OIL', ticker: 'CL=F', category: 'COMM'},
                {name: 'NAT GAS', ticker: 'NG=F', category: 'COMM'},
                {name: 'COPPER', ticker: 'HG=F', category: 'COMM'},
                {name: 'EUR/USD', ticker: 'EURUSD=X', category: 'FX'},
                {name: 'GBP/USD', ticker: 'GBPUSD=X', category: 'FX'},
                {name: 'USD/JPY', ticker: 'JPY=X', category: 'FX'},
                {name: 'VIX', ticker: '^VIX', category: 'VOL'},
                {name: 'SOXX', ticker: 'SOXX', category: 'SEMI'},
                {name: 'MAGS', ticker: 'MAGS', category: 'MAG7'},
                {name: 'CIBR', ticker: 'CIBR', category: 'CYBR'},
                {name: 'SKYY', ticker: 'SKYY', category: 'CLD'},
                {name: 'VGK', ticker: 'VGK', category: 'EUR'},
                {name: 'MCHI', ticker: 'MCHI', category: 'CHN'},
                {name: 'EWJ', ticker: 'EWJ', category: 'JPN'},
                {name: 'EEM', ticker: 'EEM', category: 'EM'},
                {name: 'TLT', ticker: 'TLT', category: 'UST'},
                {name: 'LQD', ticker: 'LQD', category: 'IG'},
                {name: 'HYG', ticker: 'HYG', category: 'HY'},
                {name: 'TIP', ticker: 'TIP', category: 'TIPS'},
                {name: 'VNQ', ticker: 'VNQ', category: 'REIT'},
                {name: 'XLU', ticker: 'XLU', category: 'UTIL'},
                {name: 'ICLN', ticker: 'ICLN', category: 'CLN'},
                {name: 'DBA', ticker: 'DBA', category: 'AGRI'},
                {name: 'LIT', ticker: 'LIT', category: 'LITH'}
            ];
            
            let html = `<div class="panel-header mb-2"><div class="section-title">GLOBAL PERFORMANCE</div></div><div class="grid grid-cols-4 md:grid-cols-7 gap-1.5">`;
            
            for (const asset of assets) {
                try {
                    const data = await fetchTicker(asset.ticker);
                    const change = parseFloat(data.main_info?.oneDayChange || 0);
                    const isPos = change >= 0;
                    const color = isPos ? 'text-green-500' : 'text-red-500';
                    const bgClass = isPos ? 'card-dynamic-positive' : 'card-dynamic-negative';
                    
                    html += `
                        <div class="panel p-2 cursor-pointer hover:border-gray-700 transition-all ${bgClass}" onclick="executeQuickCommand('GO ${asset.ticker}')">
                            <div class="text-gray-500 text-xs mb-0.5 uppercase">${asset.category}</div>
                            <div class="text-gray-300 text-xs font-bold">${asset.name}</div>
                            <div class="text-gray-200 font-mono text-xs mt-1">${data.main_info.currentPrice?.toFixed(2) || '--'}</div>
                            <div class="text-xs ${color} font-mono font-bold">${isPos ? '+' : ''}${change.toFixed(2)}%</div>
                        </div>
                    `;
                } catch (e) {
                    html += `
                        <div class="panel p-2 opacity-50">
                            <div class="text-gray-500 text-xs uppercase">${asset.category}</div>
                            <div class="text-gray-600 text-xs">${asset.name}</div>
                        </div>
                    `;
                }
            }
            html += `</div>`;
            addMessage(html);
        }

        async function loadTopNews() {
            try {
                const tickers = ['SPY', 'QQQ', 'DIA', 'SMH', 'ARKK'];
                let allNews = [];
                
                for (const ticker of tickers) {
                    try {
                        const data = await fetchTicker(ticker);
                        if (data.recent_news) {
                            data.recent_news.slice(0, 2).forEach(n => allNews.push({...n, source: ticker}));
                        }
                    } catch (e) {}
                }
                
                allNews.sort((a, b) => new Date(b.pubDate) - new Date(a.pubDate));
                
                let html = `<div class="panel-header mb-2"><div class="section-title">TOP NEWS</div></div><div class="space-y-1">`;
                
                allNews.slice(0, 10).forEach(item => {
                    const date = new Date(item.pubDate);
                    const hoursAgo = Math.floor((Date.now() - date) / 3600000);
                    const timeStr = hoursAgo < 1 ? 'NOW' : hoursAgo < 24 ? `${hoursAgo}H` : `${Math.floor(hoursAgo/24)}D`;
                    
                    html += `
                        <div class="news-item panel cursor-pointer flex gap-2 items-start" onclick="window.open('${item.source_url || '#'}', '_blank')">
                            <div class="flex-shrink-0 w-8 h-8 rounded bg-gray-800 flex items-center justify-center text-xs text-orange-600 font-mono font-bold">
                                ${item.source}
                            </div>
                            <div class="flex-1 min-w-0">
                                <div class="flex justify-between items-start">
                                    <div class="text-gray-300 text-xs line-clamp-1 pr-2">${item.title}</div>
                                    <span class="text-gray-600 text-xs font-mono whitespace-nowrap">${timeStr}</span>
                                </div>
                                <div class="text-gray-600 text-xs mt-0.5 uppercase">${item.provider}</div>
                            </div>
                        </div>
                    `;
                });
                
                html += `</div>`;
                addMessage(html);
            } catch (e) {
                throw new Error('Failed to load news');
            }
        }

        function loadEconomicCalendar() {
            const events = [
                {time: '08:30', country: 'US', indicator: 'CPI MoM', actual: '0.3%', forecast: '0.2%', previous: '0.2%', impact: 'HIGH'},
                {time: '10:00', country: 'US', indicator: 'Retail Sales', actual: '-0.1%', forecast: '0.2%', previous: '0.4%', impact: 'MED'},
                {time: '14:00', country: 'US', indicator: 'FOMC Minutes', actual: '--', forecast: '--', previous: '--', impact: 'HIGH'},
                {time: '02:00', country: 'DE', indicator: 'German GDP', actual: '0.1%', forecast: '0.0%', previous: '-0.1%', impact: 'MED'},
                {time: '04:30', country: 'UK', indicator: 'Unemployment', actual: '4.2%', forecast: '4.1%', previous: '4.0%', impact: 'MED'},
                {time: '07:30', country: 'JP', indicator: 'Ind. Production', actual: '2.1%', forecast: '1.5%', previous: '0.8%', impact: 'LOW'},
                {time: '09:00', country: 'CN', indicator: 'PMI Mfg', actual: '50.2', forecast: '49.8', previous: '49.0', impact: 'HIGH'},
                {time: '11:30', country: 'AU', indicator: 'Employment', actual: '15.2K', forecast: '20.0K', previous: '-12.5K', impact: 'MED'}
            ];
            
            let html = `<div class="panel-header mb-2"><div class="section-title">ECONOMIC CALENDAR</div></div>
                <div class="overflow-x-auto">
                <table class="w-full text-xs data-table">
                    <thead>
                        <tr>
                            <th>Time</th>
                            <th>Cnt</th>
                            <th>Indicator</th>
                            <th class="text-right">Act</th>
                            <th class="text-right">Fcst</th>
                            <th class="text-right">Prev</th>
                            <th class="text-center">Imp</th>
                        </tr>
                    </thead>
                    <tbody>`;
            
            events.forEach(event => {
                const impactColor = event.impact === 'HIGH' ? 'text-red-500' : event.impact === 'MED' ? 'text-yellow-500' : 'text-gray-500';
                
                html += `
                    <tr>
                        <td class="py-1.5 text-gray-500 font-mono">${event.time}</td>
                        <td class="py-1.5 text-gray-400">${event.country}</td>
                        <td class="py-1.5 text-gray-300">${event.indicator}</td>
                        <td class="py-1.5 text-right text-gray-300 font-mono font-bold">${event.actual}</td>
                        <td class="py-1.5 text-right text-gray-500 font-mono">${event.forecast}</td>
                        <td class="py-1.5 text-right text-gray-500 font-mono">${event.previous}</td>
                        <td class="py-1.5 text-center"><span class="${impactColor} text-xs font-bold">${event.impact}</span></td>
                    </tr>
                `;
            });
            
            html += `</tbody></table></div>
            <div class="grid grid-cols-3 gap-2 mt-3">
                <div class="panel p-2 text-center"><div class="text-gray-600 text-xs uppercase">High</div><div class="text-red-500 font-mono font-bold">3</div></div>
                <div class="panel p-2 text-center"><div class="text-gray-600 text-xs uppercase">Medium</div><div class="text-yellow-500 font-mono font-bold">5</div></div>
                <div class="panel p-2 text-center"><div class="text-gray-600 text-xs uppercase">Low</div><div class="text-gray-500 font-mono font-bold">2</div></div>
            </div>`;
            
            addMessage(html);
        }

        async function loadSectorPerformance() {
            const sectors = [
                {name: 'TECH', ticker: 'XLK', full: 'Technology'},
                {name: 'FIN', ticker: 'XLF', full: 'Financials'},
                {name: 'HLTH', ticker: 'XLV', full: 'Healthcare'},
                {name: 'ENRG', ticker: 'XLE', full: 'Energy'},
                {name: 'DISC', ticker: 'XLY', full: 'Consumer Disc'},
                {name: 'STPL', ticker: 'XLP', full: 'Staples'},
                {name: 'INDU', ticker: 'XLI', full: 'Industrials'},
                {name: 'MATL', ticker: 'XLB', full: 'Materials'},
                {name: 'UTIL', ticker: 'XLU', full: 'Utilities'},
                {name: 'REIT', ticker: 'XLRE', full: 'Real Estate'},
                {name: 'COMM', ticker: 'XLC', full: 'Communication'}
            ];
            
            let html = `<div class="panel-header mb-2"><div class="section-title">SECTOR PERFORMANCE</div></div><div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-2 mb-4">`;
            
            const results = [];
            for (const sector of sectors) {
                try {
                    const data = await fetchTicker(sector.ticker);
                    results.push({...sector, data, success: true});
                } catch (e) {
                    results.push({...sector, error: true});
                }
            }
            
            results.sort((a, b) => {
                if (!a.success) return 1;
                if (!b.success) return -1;
                return parseFloat(b.data.main_info?.oneDayChange || 0) - parseFloat(a.data.main_info?.oneDayChange || 0);
            });
            
            results.forEach((sector, idx) => {
                if (!sector.success) {
                    html += `<div class="panel p-2 opacity-50"><div class="text-gray-500 text-xs uppercase">${sector.name}</div></div>`;
                } else {
                    const change = parseFloat(sector.data.main_info?.oneDayChange || 0);
                    const color = change >= 0 ? 'text-green-500' : 'text-red-500';
                    
                    html += `
                        <div class="metric-card p-2.5 cursor-pointer hover:border-gray-700 transition-all ${change >= 0 ? 'positive' : 'negative'}" onclick="executeQuickCommand('GO ${sector.ticker}')">
                            <div class="flex justify-between items-center mb-1">
                                <span class="text-gray-500 text-xs uppercase font-bold">#${idx + 1} ${sector.name}</span>
                                <span class="${color} text-xs font-mono font-bold">${change >= 0 ? '+' : ''}${change.toFixed(2)}%</span>
                            </div>
                            <div class="flex justify-between text-xs">
                                <span class="text-gray-600 uppercase">${sector.ticker}</span>
                                <span class="text-gray-400 font-mono font-bold">$${sector.data.main_info.currentPrice?.toFixed(2)}</span>
                            </div>
                        </div>
                    `;
                }
            });
            html += `</div>`;
            
            html += `<div class="panel-header mb-2"><div class="section-title">SECTOR NEWS</div></div><div class="space-y-1">`;
            
            for (let i = 0; i < Math.min(sectors.length, 11); i++) {
                const sector = sectors[i];
                try {
                    const data = await fetchTicker(sector.ticker);
                    if (data.recent_news && data.recent_news.length > 0) {
                        const news = data.recent_news[0];
                        const date = new Date(news.pubDate);
                        const hoursAgo = Math.floor((Date.now() - date) / 3600000);
                        const timeStr = hoursAgo < 1 ? 'NOW' : hoursAgo < 24 ? `${hoursAgo}H` : `${Math.floor(hoursAgo/24)}D`;
                        
                        html += `
                            <div class="news-item panel cursor-pointer flex gap-2 items-start" onclick="window.open('${news.source_url || '#'}', '_blank')">
                                <div class="flex-shrink-0 w-8 h-8 rounded bg-gray-800 flex items-center justify-center text-xs text-orange-600 font-mono font-bold">
                                    ${sector.ticker}
                                </div>
                                <div class="flex-1 min-w-0">
                                    <div class="flex justify-between items-start">
                                        <div class="text-gray-300 text-xs line-clamp-1 pr-2">${news.title}</div>
                                        <span class="text-gray-600 text-xs font-mono whitespace-nowrap">${timeStr}</span>
                                    </div>
                                    <div class="text-gray-600 text-xs mt-0.5 uppercase">${news.provider} â€¢ ${sector.full}</div>
                                </div>
                            </div>
                        `;
                    }
                } catch(e) {}
            }
            html += `</div>`;
            
            addMessage(html);
        }

        async function loadETFView() {
            const etfsByTheme = {
                'INNOVATION': [
                    {ticker: 'ARKK', name: 'ARK Innovation', icon: 'fa-rocket'},
                    {ticker: 'ARKQ', name: 'Auto Tech', icon: 'fa-car'},
                    {ticker: 'QTUM', name: 'Quantum', icon: 'fa-atom'},
                    {ticker: 'ARKW', name: 'Next Gen', icon: 'fa-globe'}
                ],
                'TECHNOLOGY': [
                    {ticker: 'SMH', name: 'Semis', icon: 'fa-microchip'},
                    {ticker: 'SKYY', name: 'Cloud', icon: 'fa-cloud'},
                    {ticker: 'CIBR', name: 'Cyber', icon: 'fa-shield-alt'},
                    {ticker: 'BOTZ', name: 'AI/Robotics', icon: 'fa-robot'}
                ],
                'HEALTHCARE': [
                    {ticker: 'ARKG', name: 'Genomics', icon: 'fa-dna'},
                    {ticker: 'XBI', name: 'Biotech', icon: 'fa-flask'},
                    {ticker: 'PPH', name: 'Pharma', icon: 'fa-pills'},
                    {ticker: 'IHI', name: 'Med Devices', icon: 'fa-heartbeat'}
                ],
                'FINANCE': [
                    {ticker: 'ARKF', name: 'Fintech', icon: 'fa-credit-card'},
                    {ticker: 'BLOK', name: 'Blockchain', icon: 'fa-link'},
                    {ticker: 'IPAY', name: 'Mobile Pay', icon: 'fa-mobile-alt'},
                    {ticker: 'FINX', name: 'FinTech', icon: 'fa-university'}
                ],
                'ENERGY & MATERIALS': [
                    {ticker: 'ICLN', name: 'Clean Energy', icon: 'fa-solar-panel'},
                    {ticker: 'LIT', name: 'Lithium', icon: 'fa-battery-full'},
                    {ticker: 'URA', name: 'Uranium', icon: 'fa-radiation'},
                    {ticker: 'COPX', name: 'Copper', icon: 'fa-coins'}
                ],
                'SPACE & DEFENSE': [
                    {ticker: 'ARKX', name: 'Space', icon: 'fa-space-shuttle'},
                    {ticker: 'ITA', name: 'Aerospace', icon: 'fa-plane'},
                    {ticker: 'XAR', name: 'Defense', icon: 'fa-fighter-jet'},
                    {ticker: 'PPA', name: 'Aero/Def', icon: 'fa-shield-alt'}
                ]
            };
            
            let html = `<div class="panel-header mb-2"><div class="section-title">ETF THEMES</div></div><div class="space-y-3">`;
            
            for (const [theme, etfs] of Object.entries(etfsByTheme)) {
                html += `<div><div class="text-gray-500 text-xs mb-1.5 uppercase flex items-center gap-2 font-bold"><i class="fas ${etfs[0].icon} text-orange-600 text-xs"></i> ${theme}</div><div class="grid grid-cols-2 md:grid-cols-4 gap-2">`;
                
                for (const etf of etfs) {
                    try {
                        const data = await fetchTicker(etf.ticker);
                        const change = parseFloat(data.main_info?.oneDayChange || 0);
                        const isPos = change >= 0;
                        const color = isPos ? 'text-green-500' : 'text-red-500';
                        const bgClass = isPos ? 'card-dynamic-positive' : 'card-dynamic-negative';
                        
                        html += `
                            <div class="panel p-2 cursor-pointer hover:border-gray-700 transition-all ${bgClass}" onclick="executeQuickCommand('GO ${etf.ticker}')">
                                <div class="flex justify-between items-center mb-0.5">
                                    <span class="text-gray-400 text-xs truncate flex-1 uppercase font-bold">${etf.name}</span>
                                    <i class="fas ${etf.icon} text-gray-600 text-xs ml-1"></i>
                                </div>
                                <div class="text-gray-300 text-xs font-mono font-bold">${etf.ticker}</div>
                                <div class="flex justify-between items-center mt-1">
                                    <span class="text-gray-300 font-mono text-xs">$${data.main_info.currentPrice?.toFixed(2)}</span>
                                    <span class="${color} text-xs font-mono font-bold">${isPos ? '+' : ''}${change.toFixed(2)}%</span>
                                </div>
                            </div>
                        `;
                    } catch (e) {
                        html += `<div class="panel p-2 opacity-50"><div class="text-gray-500 text-xs truncate uppercase">${etf.name}</div><div class="text-gray-600 text-xs">${etf.ticker}</div></div>`;
                    }
                }
                html += `</div></div>`;
            }
            html += `</div>`;

            html += `<div class="panel-header mb-2 mt-4"><div class="section-title">ETF NEWS FEED</div></div><div class="space-y-1">`;
            
            const etfNewsTickers = ['ARKK', 'QTUM', 'SMH', 'ICLN', 'ARKX'];
            let allETFNews = [];
            
            for (const ticker of etfNewsTickers) {
                try {
                    const data = await fetchTicker(ticker);
                    if (data.recent_news) {
                        data.recent_news.forEach(news => {
                            allETFNews.push({
                                ...news,
                                source: ticker,
                                sourceName: data.shortName || ticker
                            });
                        });
                    }
                } catch (e) {}
            }
            
            allETFNews.sort((a, b) => new Date(b.pubDate) - new Date(a.pubDate));
            
            allETFNews.slice(0, 10).forEach(item => {
                const date = new Date(item.pubDate);
                const hoursAgo = Math.floor((Date.now() - date) / 3600000);
                const timeStr = hoursAgo < 1 ? 'NOW' : hoursAgo < 24 ? `${hoursAgo}H` : `${Math.floor(hoursAgo/24)}D`;
                
                html += `
                    <div class="news-item panel cursor-pointer flex gap-2 items-start" onclick="window.open('${item.source_url || '#'}', '_blank')">
                        <div class="flex-shrink-0 w-10 h-8 rounded bg-gray-800 flex items-center justify-center text-xs text-orange-600 font-mono font-bold">
                            ${item.source}
                        </div>
                        <div class="flex-1 min-w-0">
                            <div class="flex justify-between items-start">
                                <div class="text-gray-300 text-xs line-clamp-1 pr-2">${item.title}</div>
                                <span class="text-gray-600 text-xs font-mono whitespace-nowrap">${timeStr}</span>
                            </div>
                            <div class="text-gray-600 text-xs mt-0.5 uppercase">${item.provider}</div>
                        </div>
                    </div>
                `;
            });
            
            html += `</div>`;
            
            addMessage(html);
        }

        async function loadStockMatrix() {
            const allTickers = ['AAPL', 'MSFT', 'GOOGL', 'AMZN', 'NVDA', 'WMT', 'META', 'NFLX', 'AMD', 'INTC',
                            'IREN', 'NBIS', 'CRWD', 'RKLB', 'ASTS', 'LUNR',
                            'SOXX', 'SMH', 'SKYY', 'CIBR', 'BOTZ', 'ICLN',
                            'SOUN', 'BBAI', 'RGTI', 'QBTS', 'IONQ',
                            'ARKK', 'ARKG', 'ARKQ', 'ARKW', 'ARKF', 'ARKX'];
            
            let html = `
                <div class="panel-header mb-2">
                    <div class="section-title">STOCK MATRIX <span class="text-gray-600 font-normal">${allTickers.length} Securities</span></div>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full text-xs data-table">
                        <thead>
                            <tr>
                                <th>Ticker</th>
                                <th class="text-right">Price</th>
                                <th class="text-right">Chg%</th>
                                <th class="text-right">MktCap</th>
                                <th class="text-right">P/E</th>
                                <th class="text-right">Fwd</th>
                                <th class="text-right">P/S</th>
                                <th class="text-center">Rec</th>
                                <th class="text-right">PT</th>
                                <th class="text-right">52W%</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            for (const ticker of allTickers) {
                try {
                    const data = await fetchTicker(ticker);
                    const info = data.main_info;
                    const change = parseFloat(info.oneDayChange || 0);
                    const price = info.currentPrice || 0;
                    const perf = data.price_performance;
                    const priceDiff52W = perf.fiftyTwoWeekHigh ? ((price - perf.fiftyTwoWeekHigh) / perf.fiftyTwoWeekHigh * 100) : 0;
                    
                    const changeColor = change >= 0 ? 'text-green-500' : 'text-red-500';
                    const recommColor = data.price_targets.recommendationKey?.toLowerCase().includes('buy') ? 'text-green-500' : 
                                       data.price_targets.recommendationKey?.toLowerCase().includes('sell') ? 'text-red-500' : 'text-yellow-500';
                    
                    html += `
                        <tr class="cursor-pointer" onclick="executeQuickCommand('GO ${ticker}')">
                            <td class="py-1.5 text-orange-600 font-mono font-bold">${ticker}</td>
                            <td class="py-1.5 text-right text-gray-300 font-mono font-bold">$${price.toFixed(2)}</td>
                            <td class="py-1.5 text-right ${changeColor} font-mono font-bold">${change >= 0 ? '+' : ''}${change.toFixed(2)}%</td>
                            <td class="py-1.5 text-right text-gray-400">${info.marketCap || '--'}</td>
                            <td class="py-1.5 text-right text-gray-400">${info.PE?.toFixed(1) || '--'}</td>
                            <td class="py-1.5 text-right text-gray-400">${info.forwardPE?.toFixed(1) || '--'}</td>
                            <td class="py-1.5 text-right text-gray-400">${info.PS?.toFixed(2) || '--'}</td>
                            <td class="py-1.5 text-center ${recommColor} uppercase text-xs font-bold">${data.price_targets.recommendationKey || '--'}</td>
                            <td class="py-1.5 text-right text-gray-400">$${data.price_targets.targetMeanPrice?.toFixed(0) || '--'}</td>
                            <td class="py-1.5 text-right ${priceDiff52W >= -10 ? 'text-green-500' : priceDiff52W >= -25 ? 'text-yellow-500' : 'text-red-500'}">${priceDiff52W.toFixed(1)}%</td>
                        </tr>
                    `;
                } catch (e) {
                    html += `
                        <tr class="opacity-50">
                            <td class="py-1.5 text-orange-600">${ticker}</td>
                            <td colspan="9" class="py-1.5 text-red-500 text-xs">ERR</td>
                        </tr>
                    `;
                }
            }
            
            html += `
                        </tbody>
                    </table>
                </div>
                <div class="mt-2 text-xs text-gray-600 text-right font-mono">
                    Last update: ${new Date().toLocaleTimeString()}
                </div>
            `;
            
            addMessage(html);
        }

        async function loadCryptoView() {
            const topCryptos = [
                {ticker: 'BTC-USD', name: 'Bitcoin', symbol: 'BTC'},
                {ticker: 'ETH-USD', name: 'Ethereum', symbol: 'ETH'},
                {ticker: 'BNB-USD', name: 'BNB', symbol: 'BNB'},
                {ticker: 'XRP-USD', name: 'XRP', symbol: 'XRP'},
                {ticker: 'ADA-USD', name: 'Cardano', symbol: 'ADA'},
                {ticker: 'DOGE-USD', name: 'Dogecoin', symbol: 'DOGE'},
                {ticker: 'SOL-USD', name: 'Solana', symbol: 'SOL'},
                {ticker: 'DOT-USD', name: 'Polkadot', symbol: 'DOT'},
                {ticker: 'MATIC-USD', name: 'Polygon', symbol: 'MATIC'},
                {ticker: 'AVAX-USD', name: 'Avalanche', symbol: 'AVAX'}
            ];
            
            let html = `<div class="panel-header mb-2"><div class="section-title">CRYPTO MARKET</div></div>`;
            
            html += `<div class="grid grid-cols-2 md:grid-cols-4 gap-2 mb-4">`;
            
            try {
                const btcData = await fetchTicker('BTC-USD');
                const btcChange = parseFloat(btcData.main_info?.oneDayChange || 0);
                html += `
                    <div class="metric-card ${btcChange >= 0 ? 'positive' : 'negative'} p-3 text-center">
                        <div class="text-gray-600 text-xs uppercase mb-1">BTC/USD</div>
                        <div class="text-gray-300 font-mono text-lg font-bold">$${btcData.main_info.currentPrice?.toLocaleString('en-US', {maximumFractionDigits: 0}) || '--'}</div>
                        <div class="${btcChange >= 0 ? 'text-green-500' : 'text-red-500'} text-xs font-mono font-bold">${btcChange >= 0 ? '+' : ''}${btcChange.toFixed(2)}%</div>
                    </div>
                `;
            } catch(e) {
                html += `<div class="metric-card p-3 text-center"><div class="text-gray-600 text-xs uppercase">BTC/USD</div><div class="text-gray-400">--</div></div>`;
            }
            
            try {
                const ethData = await fetchTicker('ETH-USD');
                const ethChange = parseFloat(ethData.main_info?.oneDayChange || 0);
                html += `
                    <div class="metric-card ${ethChange >= 0 ? 'positive' : 'negative'} p-3 text-center">
                        <div class="text-gray-600 text-xs uppercase mb-1">ETH/USD</div>
                        <div class="text-gray-300 font-mono text-lg font-bold">$${ethData.main_info.currentPrice?.toLocaleString('en-US', {maximumFractionDigits: 0}) || '--'}</div>
                        <div class="${ethChange >= 0 ? 'text-green-500' : 'text-red-500'} text-xs font-mono font-bold">${ethChange >= 0 ? '+' : ''}${ethChange.toFixed(2)}%</div>
                    </div>
                `;
            } catch(e) {
                html += `<div class="metric-card p-3 text-center"><div class="text-gray-600 text-xs uppercase">ETH/USD</div><div class="text-gray-400">--</div></div>`;
            }
            
            html += `
                <div class="metric-card p-3 text-center">
                    <div class="text-gray-600 text-xs uppercase mb-1">TOTAL MKT CAP</div>
                    <div class="text-gray-300 font-mono text-lg font-bold">$2.4T</div>
                    <div class="text-gray-500 text-xs uppercase">Global Crypto</div>
                </div>
                <div class="metric-card p-3 text-center">
                    <div class="text-gray-600 text-xs uppercase mb-1">BTC DOMINANCE</div>
                    <div class="text-gray-300 font-mono text-lg font-bold">52.3%</div>
                    <div class="text-gray-500 text-xs uppercase">Market Share</div>
                </div>
            `;
            
            html += `</div>`;
            
            html += `
                <div class="panel-header mb-2"><div class="section-title">TOP 10 CRYPTOCURRENCIES</div></div>
                <div class="overflow-x-auto">
                    <table class="w-full text-xs data-table">
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>Name</th>
                                <th>Symbol</th>
                                <th class="text-right">Price</th>
                                <th class="text-right">Change%</th>
                                <th class="text-right">Mkt Cap</th>
                                <th class="text-right">Volume(24h)</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            let rank = 1;
            for (const crypto of topCryptos) {
                try {
                    const data = await fetchTicker(crypto.ticker);
                    const change = parseFloat(data.main_info?.oneDayChange || 0);
                    const color = change >= 0 ? 'text-green-500' : 'text-red-500';
                    
                    html += `
                        <tr class="cursor-pointer" onclick="executeQuickCommand('GO ${crypto.ticker}')">
                            <td class="py-1.5 text-gray-500 font-mono">${rank}</td>
                            <td class="py-1.5 text-gray-300">${crypto.name}</td>
                            <td class="py-1.5 text-orange-600 font-mono font-bold">${crypto.symbol}</td>
                            <td class="py-1.5 text-right text-gray-300 font-mono font-bold">$${data.main_info.currentPrice?.toLocaleString('en-US', {maximumFractionDigits: 2}) || '--'}</td>
                            <td class="py-1.5 text-right ${color} font-mono font-bold">${change >= 0 ? '+' : ''}${change.toFixed(2)}%</td>
                            <td class="py-1.5 text-right text-gray-400">${data.main_info.marketCap || '--'}</td>
                            <td class="py-1.5 text-right text-gray-400">${(data.main_info.volume / 1e9).toFixed(2)}B</td>
                        </tr>
                    `;
                } catch(e) {
                    html += `
                        <tr class="opacity-50">
                            <td class="py-1.5 text-gray-500">${rank}</td>
                            <td class="py-1.5 text-gray-400">${crypto.name}</td>
                            <td class="py-1.5 text-orange-600">${crypto.symbol}</td>
                            <td colspan="4" class="py-1.5 text-gray-600 text-xs">--</td>
                        </tr>
                    `;
                }
                rank++;
            }
            
            html += `
                        </tbody>
                    </table>
                </div>
            `;
            
            addMessage(html);
        }

        async function loadBondOutlook() {
            let html = `<div class="panel-header mb-2"><div class="section-title">RATES OUTLOOK</div></div>`;
            
            html += `<div class="mb-4"><div class="text-gray-500 text-xs mb-2 uppercase font-bold">Government Rates</div><div class="grid grid-cols-2 md:grid-cols-4 gap-2">`;
            
            const govRates = [
                {name: 'US 2Y', ticker: '2YY=F'},
                {name: 'US 10Y', ticker: 'ZN=F'},
                {name: 'DXY', ticker: 'DX-Y.NYB'},
                {name: 'EUR/USD', ticker: 'EURUSD=X'}
            ];
            
            for (const rate of govRates) {
                try {
                    const data = await fetchTicker(rate.ticker);
                    const change = parseFloat(data.main_info?.oneDayChange || 0);
                    const isYield = rate.name.includes('Y');
                    const displayValue = isYield ? data.main_info.currentPrice?.toFixed(2) + '%' : data.main_info.currentPrice?.toFixed(2);
                    
                    html += `
                        <div class="metric-card p-2 text-center ${change >= 0 ? 'positive' : 'negative'}" onclick="executeQuickCommand('GO ${rate.ticker}')">
                            <div class="text-gray-500 text-xs uppercase font-bold">${rate.name}</div>
                            <div class="text-gray-300 font-mono text-lg font-bold">${displayValue || '--'}</div>
                            <div class="${change >= 0 ? 'text-green-500' : 'text-red-500'} text-xs font-mono font-bold">${change >= 0 ? '+' : ''}${change.toFixed(2)}%</div>
                        </div>
                    `;
                } catch(e) {
                    html += `<div class="metric-card p-2 text-center opacity-50"><div class="text-gray-500 text-xs uppercase">${rate.name}</div><div class="text-gray-600">--</div></div>`;
                }
            }
            html += `</div></div>`;
            
            html += `<div class="mb-4"><div class="text-gray-500 text-xs mb-2 uppercase font-bold">Credit Markets</div><div class="grid grid-cols-2 md:grid-cols-4 gap-2">`;
            
            const creditRates = [
                {name: 'US IG', ticker: 'LQD', type: 'ETF'},
                {name: 'US HY', ticker: 'HYG', type: 'ETF'},
                {name: 'EM USD', ticker: 'EMB', type: 'ETF'},
                {name: 'TIPS', ticker: 'TIP', type: 'ETF'}
            ];
            
            for (const rate of creditRates) {
                try {
                    const data = await fetchTicker(rate.ticker);
                    const change = parseFloat(data.main_info?.oneDayChange || 0);
                    
                    html += `
                        <div class="metric-card p-2 ${change >= 0 ? 'positive' : 'negative'}" onclick="executeQuickCommand('GO ${rate.ticker}')">
                            <div class="flex justify-between items-center">
                                <span class="text-gray-500 text-xs uppercase font-bold">${rate.name}</span>
                                <span class="${change >= 0 ? 'text-green-500' : 'text-red-500'} text-xs font-mono font-bold">${change >= 0 ? '+' : ''}${change.toFixed(2)}%</span>
                            </div>
                            <div class="text-gray-300 font-mono text-sm font-bold">$${data.main_info.currentPrice?.toFixed(2)}</div>
                        </div>
                    `;
                } catch(e) {
                    html += `<div class="metric-card p-2 opacity-50"><div class="text-gray-500 text-xs uppercase">${rate.name}</div><div class="text-gray-600">--</div></div>`;
                }
            }
            html += `</div></div>`;
            
            html += `<div class="grid grid-cols-3 gap-2 text-xs">
                <div class="metric-card p-2 text-center">
                    <div class="text-gray-600 text-xs uppercase">2s10s Spread</div>
                    <div class="text-gray-400 font-mono font-bold">-35bps</div>
                </div>
                <div class="metric-card p-2 text-center">
                    <div class="text-gray-600 text-xs uppercase">IG Spread</div>
                    <div class="text-gray-400 font-mono font-bold">85bps</div>
                </div>
                <div class="metric-card p-2 text-center">
                    <div class="text-gray-600 text-xs uppercase">HY Spread</div>
                    <div class="text-gray-400 font-mono font-bold">320bps</div>
                </div>
            </div>`;
            
            addMessage(html);
        }

        commandInput.focus();
        initTicker();
    </script>
</body>
</html>
